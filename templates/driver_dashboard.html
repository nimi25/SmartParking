<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Parking - Driver Dashboard</title>
  <!-- Designer Base Styles + Extra Styles for Map/Search/Modal -->
  <style>
    /* Designerâ€™s Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }
    body {
      background: #121212 url("../static/images/background.jpg") no-repeat center center;
      background-size: cover;
      color: #e0e0e0;
    }
    header {
      background: #1f1f1f;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #333;
    }
    header h1 {
      font-size: 1.75rem;
      letter-spacing: 1px;
    }
    nav a {
      margin-left: 1.5rem;
      text-decoration: none;
      transition: opacity 0.3s;
    }
    nav a img {
      width: 40px;
      height: 40px;
      vertical-align: middle;
    }
    nav a:hover {
      opacity: 0.8;
    }
    .dashboard {
      display: grid;
      grid-template-columns: 250px 1fr;
      min-height: calc(100vh - 70px);
    }
    <!-- Sidebar using url_for endpoints -->
    .sidebar {
      background: #1f1f1f;
      padding: 2rem 1rem;
      border-right: 2px solid #333;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .sidebar a {
      display: block;
      padding: 0.75rem 1rem;
      color: #e0e0e0;
      text-decoration: none;
      border-left: 4px solid transparent;
      transition: background 0.3s, border-color 0.3s;
    }
    .sidebar a:hover,
    .sidebar a.active {
      background: #333;
      border-left: 4px solid #00e5ff;
    }
    .content {
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
    }
    /* Welcome & Map Card */
    .welcome-map-card {
      width: 1300px;
      height: 600px;
      background: #1f1f1f;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      animation: fadeIn 1s ease;
    }
    .welcome-map-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.6);
    }
    .welcome {
      text-align: center;
    }
    .welcome h3 {
      color: #00e5ff;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    .welcome p {
      font-size: 1rem;
      color: #cfcfcf;
    }
    /* Map Container */
    .map-container {
      position: relative;
      background: #333;
      border-radius: 8px;
      flex-grow: 1;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    /* Map Search Overlay */
    .map-search {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      z-index: 1000;
    }
    .map-search input {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: none;
    }
    .suggestions {
      position: absolute;
      top: 45px;
      width: 100%;
      background: #fff;
      color: #000;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    .suggestion-item {
      padding: 8px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background: #eee;
    }
    /* Quick Actions Card */
    .quick-actions-card {
      background: #1f1f1f;
      padding: 1.5rem;
      border-radius: 12px;
      width: 600px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
      animation: fadeIn 1.2s ease;
    }
    .quick-actions-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.6);
    }
    .quick-actions-card h3 {
      color: #00e5ff;
      margin-bottom: 1rem;
    }
    .quick-actions {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .quick-actions a {
      text-decoration: none;
    }
    .action-btn {
      background: #00e5ff;
      color: #000;
      padding: 0.75rem 1.25rem;
      border-radius: 4px;
      font-weight: 600;
      transition: background 0.3s;
    }
    .action-btn:hover {
      background: #00cce0;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Booking Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #1f1f1f;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      position: relative;
    }
    .modal-content .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #fff;
    }
    .modal-content .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    .modal-content .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #fff;
    }
    .modal-content input[type="number"],
    .modal-content input[type="time"] {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .modal-content button {
      padding: 10px 15px;
      background: #00e5ff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
  <!-- External Libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        integrity="sha512-Fo3rlrZj/kTc7I4YWgW0E8S7zx1+Y8Y3vT94r3Z6YV1gHOb/A6z/9zsR5/sLbcX8FwHsw2cG6z1w0Oj5mwOW5w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
  <header>
    <h1>Driver Dashboard</h1>
    <nav>
      <a href="{{ url_for('profile.driver_profile') }}">
        <img src="../static/images/profile.jpg" alt="Profile" />
      </a>
      <a href="{{ url_for('auth.logout') }}">
        <img src="../static/images/logout.jpg" alt="Logout" />
      </a>
    </nav>
  </header>
  <div class="dashboard">
    <aside class="sidebar">
      <a href="{{ url_for('dashboard.driver_dashboard') }}" class="active">Home</a>
      <a href="{{ url_for('dashboard.my_bookings') }}">My Bookings</a>
      <a href="{{ url_for('dashboard.history_driver') }}">History</a>
    </aside>
    <main class="content">
      <!-- Combined Welcome & Map Card -->
      <div class="welcome-map-card">
        <div class="welcome">
          <h3>Welcome, Driver!</h3>
          <p>Good day, {{ current_user.name or "Driver" }}! Check your current location and monitor your journey.</p>
        </div>
        <div class="map-container">
          <div id="map"></div>
          <!-- Map Search Overlay -->
          <div class="map-search">
            <input type="text" id="mapSearchInput" placeholder="Search locality...">
            <div id="suggestions" class="suggestions"></div>
          </div>
        </div>
      </div>
      <!-- Quick Actions Card -->
      <div class="quick-actions-card">
        <h3>Quick Actions</h3>
        <div class="quick-actions">
          <a href="{{ url_for('dashboard.my_bookings') }}"><div class="action-btn">My Bookings</div></a>
          <a href="{{ url_for('dashboard.history_driver') }}"><div class="action-btn">History</div></a>
        </div>
      </div>
    </main>
  </div>
  <!-- Booking Modal -->
  <div id="bookingModal" class="modal">
    <div class="modal-content">
      <span id="bookingModalClose" class="close">&times;</span>
      <h3>Book Your Spot</h3>
      <form id="bookingForm" method="POST" action="">
        <div class="form-group">
          <label for="two_wheeler">2-Wheeler Spots:</label>
          <input type="number" id="two_wheeler" name="two_wheeler" min="0" value="1" required>
        </div>
        <div class="form-group">
          <label for="four_wheeler">4-Wheeler Spots:</label>
          <input type="number" id="four_wheeler" name="four_wheeler" min="0" value="0" required>
        </div>
        <div class="form-group">
          <label for="booking_start">Booking Start (HH:MM):</label>
          <input type="time" id="booking_start" name="booking_start" required>
        </div>
        <div class="form-group">
          <label for="booking_end">Booking End (HH:MM):</label>
          <input type="time" id="booking_end" name="booking_end" required>
        </div>
        <button type="submit">Confirm Booking</button>
      </form>
    </div>
  </div>
  <script>
    // Initialize the Leaflet map
    var map = L.map('map').setView([12.9716, 77.5946], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Update current location marker
    var currentLocationMarker;
    function updateCurrentLocation() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
      }
      navigator.geolocation.getCurrentPosition(function(pos) {
        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;
        var redIcon = L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });
        if (currentLocationMarker) {
          currentLocationMarker.setLatLng([lat, lng]);
        } else {
          currentLocationMarker = L.marker([lat, lng], {icon: redIcon}).addTo(map)
            .bindPopup("You are here");
        }
      }, function(err) {
        console.error(err);
        alert("Could not get current location.");
      }, { enableHighAccuracy: true });
    }
    updateCurrentLocation();

    // Available spots data passed from backend
    var spotsData = [
      {% for spot in available_spots %}
      {
        id: "{{ spot.id }}",
        lat: {{ spot.lat }},
        lng: {{ spot.lng }},
        price: parseFloat("{{ spot.price }}"),
        from: "{{ spot.available_from.strftime('%H:%M') if spot.available_from else '' }}",
        to: "{{ spot.available_to.strftime('%H:%M') if spot.available_to else '' }}",
        location: "{{ spot.location }}"
      },
      {% endfor %}
    ];

    // Add markers for each available spot with a Book button in popup
    var markers = {};
    spotsData.forEach(function(s) {
      var marker = L.marker([s.lat, s.lng]).addTo(map)
        .bindPopup("<b>" + s.location + "</b><br>â‚¹" + s.price + "<br><button onclick='openBookingModal(\"" + s.id + "\", \"" + s.from + "\", \"" + s.to + "\")'>Book</button>");
      markers[s.id] = marker;
    });

    // Search functionality with debounce
    var mapSearchInput = document.getElementById("mapSearchInput");
    var suggestionsEl = document.getElementById("suggestions");
    var searchTimeout = null;
    mapSearchInput.addEventListener("input", function() {
      clearTimeout(searchTimeout);
      var query = this.value.trim();
      if(query.length < 3) {
        suggestionsEl.style.display = "none";
        return;
      }
      searchTimeout = setTimeout(function() {
        var url = "https://nominatim.openstreetmap.org/search?format=json&countrycodes=in&q=" + encodeURIComponent(query);
        fetch(url)
          .then(r => r.json())
          .then(data => {
            suggestionsEl.innerHTML = "";
            if(data && data.length > 0) {
              data.forEach(function(item) {
                var div = document.createElement("div");
                div.className = "suggestion-item";
                div.textContent = item.display_name;
                div.addEventListener("click", function() {
                  var lat = parseFloat(item.lat);
                  var lng = parseFloat(item.lon);
                  map.setView([lat, lng], 14);
                  suggestionsEl.style.display = "none";
                  mapSearchInput.value = item.display_name;
                });
                suggestionsEl.appendChild(div);
              });
              suggestionsEl.style.display = "block";
            } else {
              suggestionsEl.innerHTML = "<div class='suggestion-item'>No results found</div>";
              suggestionsEl.style.display = "block";
            }
          });
      }, 300);
    });

    // Booking Modal functions
    function openBookingModal(spotId, fromTime, toTime) {
      var bookingForm = document.getElementById("bookingForm");
      bookingForm.action = "/parking/book/" + spotId;
      if(fromTime) document.getElementById("booking_start").value = fromTime;
      if(toTime) document.getElementById("booking_end").value = toTime;
      document.getElementById("bookingModal").style.display = "flex";
    }
    document.getElementById("bookingModalClose").onclick = function() {
      document.getElementById("bookingModal").style.display = "none";
    };
    window.onclick = function(event) {
      if(event.target === document.getElementById("bookingModal")) {
        document.getElementById("bookingModal").style.display = "none";
      }
    };
  </script>
</body>
</html>
